--- ./config/menu_mapping.sh ---
#!/bin/bash
# menu_mapping.sh - All menu items and their commands

declare -A MENU_MAP=(
    # Typing Tools
    ["Type clipboard"]="type_clipboard"
    ["Type date"]="type_date"
    ["Type hostname"]="type_hostname"
    ["Type local ip"]="type_local_ip"
    ["Type vmpwd"]="type_vmpwd"
    ["Type veracrypt pwd"]="type_veracrypt_pwd"
    ["Share clipboard (x0pipe)"]="share_clipboard_text"
    
    # Swayr / Window Management
    ["Steal window"]="swayr_steal_window"
    ["Switch window"]="swayr_switch_window"
    ["Switch workspace"]="swayr_switch_workspace"
    ["Move focused to workspace"]="swayr_move_focused_to_workspace"
    
    # Display Movements (Using the new generic move_to function)
    ["Move to L"]="move_to L"
    ["Move to LL"]="move_to LL"
    ["Move to M"]="move_to M"
    ["Move to MON_KB"]="move_to MON_KB"
    ["Move to R"]="move_to R"
    ["Move to RR"]="move_to RR"
    ["Move to TAIKO"]="move_to TAIKO"
    
    # Display Toggles (Using the new generic display_cmd function)
    ["Enable L"]="display_cmd enable L"
    ["Disable L"]="display_cmd disable L"
    ["Enable All Seat Displays"]="display_cmd enable L LL M MON_KB R RR"
    ["Enable Support All"]="display_cmd enable L M R LL MON_KB RR"
    ["Disable Support All"]="display_cmd disable L M R LL MON_KB RR"
    ["Enable Main Support + Taiko"]="display_cmd enable L M R TAIKO"
    ["Disable Main Support + Taiko"]="display_cmd disable L M R TAIKO"
    
    # Applications
    ["Focus OpenTaiko"]="focus_opentaiko"
    ["Kill Cultris II"]="kill_cultris2"
    ["Realign mpv Openmusic"]="realign_mpv_openmusic"
    ["Follow journalctl"]="follow_journalctl"
    ["Set refresh rate"]="set_refresh_rate"
    ["MAL Synopsis from clipboard"]="myanimelist_synopsis_clipboard"
)--- ./lib/apps.sh ---
#!/bin/bash

# menu: Swayr Window Management | Steal window
sw_steal() { swayr steal-window; }

# menu: Focus Controls | ü•Å Focus OpenTaiko
foc_taiko() { swaymsg '[class="^(OpenTaiko|opentaiko.exe)$"] focus'; }

# menu: Window Realignment | Realign mpv Openmusic
realign_mpv() {
    local ids=$(ps aux | grep -Eo 'mpvfloat[0-9]+' | sort -u)
    local counter=0
    swaymsg workspace 18
    swaymsg "[app_id=\"^mpvfloat\d+$\"] move to workspace 18"
    while IFS= read -r id; do
        [ -z "$id" ] && continue
        local x=$((2160 + (counter % 10) * 192))
        local y=$((1679 + (counter / 10) * 108))
        swaymsg "[app_id=\"^$id$\"] move absolute position ${x}px ${y}px"
        ((counter++))
    done <<<"$ids"
}

# menu: System | üßæ Follow journalctl
sys_logs() {
    alacritty --title "Floating Terminal" -e bash -c "sudo journalctl -f"
}

# menu: Process Management | Kill Cultris II
k_cultris() { pkill -9 -f cultris2.jar; }--- ./lib/system_functions.sh ---
#!/bin/bash
# system_functions.sh - System utilities

follow_journalctl() {
    alacritty \
        --config-file="$USER_HOME/.config/alacritty/alacritty_non_opaque.toml" \
        --class alacritty_floating \
        --title "Floating Terminal" \
        --working-directory "$USER_HOME" \
        -e bash -c "sudo journalctl -f"
}
--- ./lib/application_functions.sh ---
# application_functions.sh
kill_cultris2() {
    pkill -9 -f cultris2.jar && notify-send "Cultris II" "Terminated" || notify-send "Cultris II" "Not running"
}

focus_opentaiko() { swaymsg '[class="^(OpenTaiko|opentaiko.exe)$"] focus'; }

follow_journalctl() {
    alacritty --config-file="$USER_HOME/.config/alacritty/alacritty_non_opaque.toml" \
              --class alacritty_floating --title "Floating Terminal" -e bash -c "sudo journalctl -f"
}

realign_mpv_openmusic() {
    local ids=$(ps aux | grep -Eo 'mpvfloat[0-9]+' | sort -u)
    local counter=0
    swaymsg workspace 18
    swaymsg "[app_id=\"^mpvfloat\d+$\"] move to workspace 18"
    while IFS= read -r id; do
        [ -z "$id" ] && continue
        local x=$((2160 + (counter % 10) * 192))
        local y=$((1679 + (counter / 10) * 108))
        swaymsg "[app_id=\"^$id$\"] move to workspace 18, move absolute position ${x}px ${y}px"
        ((counter++))
    done <<<"$ids"
}

# dotoold_manager.sh
start_dotoold() {
    pgrep -x dotoold >/dev/null || (nohup dotoold >/dev/null 2>&1 & echo "dotoold started")
}--- ./lib/display_functions.sh ---
#!/bin/bash

# Internal helper (not in menu)
_disp() { swaymsg output "'${!2}'" "$1"; }

# menu: Display Controls | üîÑ Set refresh rate
set_refresh_rate() {
    local rate=$(wofi --dmenu -p "Hz")
    [ -z "$rate" ] && return
    for i in $(lshz | grep -o "DP-[0-9]"); do
        swaymsg output "$i" resolution 1920x1080@"$rate"Hz
    done
}

# menu: Display Controls | ‚ùå Disable L
disable_L() { _disp disable L; }
# menu: Display Controls | ‚úÖ Enable L
enable_L() { _disp enable L; }

# menu: Display Controls | ‚ùå Disable main support
disable_main() { for d in L M R; do _disp disable $d; done; }
# menu: Display Controls | ‚úÖ Enable main support
enable_main() { for d in L M R; do _disp enable $d; done; }

# menu: Display Controls | Enable all Seat Displays
enable_all_seat() { for d in L LL M MON_KB R RR; do _disp enable $d; done; }

# menu: Move Window to Display | Move to L
mov_L() { swaymsg move container to output "'$L'"; }
# menu: Move Window to Display | ü•Å Move to TAIKO
mov_T() { swaymsg move container to output "'$TAIKO'"; }--- ./lib/typing_functions.sh ---
#!/bin/bash

# menu: Typing Tools | Type clipboard
type_clipboard() {
    local text=$(wl-paste)
    [ -n "$text" ] && printf 'key leftctrl\ntype %s\n' "$text" | dotoolc
}

# menu: Typing Tools | Type date
type_date() { printf 'key leftctrl\ntype %s\n' "$(date --iso-8601)" | dotoolc; }

# menu: Typing Tools | Type hostname
type_hostname() { printf 'key leftctrl\ntype %s\n' "$(hostname)/" | dotoolc; }

# menu: Typing Tools | Type http+hostname
type_http_hostname() { printf 'key leftctrl\ntype %s\n' "http://$(hostname)/" | dotoolc; }

# menu: Typing Tools | Type local ip
type_local_ip() {
    local ip=$(ip addr show | grep -i 'inet 192' | awk '{print $2}' | cut -d/ -f1 | head -n 1)
    printf 'key leftctrl\ntype %s\n' "$ip" | dotoolc
}

# menu: Typing Tools | Type vmpwd
type_vmpwd() {
    [ -n "$vmpwd" ] && printf 'key leftctrl\ntype %s\nkey Tab\nkey space\nkey Tab\nkey space\n' "$vmpwd" | dotoolc
}

# menu: Typing Tools | x0pipeclip
share_clipboard_text() {
    source /home/blu/scripts/functions/in_use/transfers/paste_services
    x0pipeclip "$(wl-paste)"
}

# menu: MyAnimeList | MAL Synopsis from clipboard
mal_synopsis() {
    "$USER_HOME"/.config/sway/scripts/myanimelist_coverart_search.sh "$(wl-paste)"
}--- ./lib/window_functions.sh ---
#!/bin/bash

move_to() {
    local display_id="${!1}"
    if [ -n "$display_id" ]; then
        swaymsg move container to output "'$display_id'"
    else
        notify-send "$1 display not defined"
    fi
}

swayr_steal_window() { swayr steal-window; }
swayr_switch_window() { swayr switch-window; }
swayr_switch_workspace() { swayr switch-workspace; }
swayr_move_focused_to_workspace() { swayr move-focused-to-workspace; }--- ./lib/dotoold_manager.sh ---
#!/bin/bash
# dotoold_manager.sh - Manages dotoold daemon

start_dotoold() {
    if ! pgrep -x dotoold >/dev/null; then
        nohup dotoold >/dev/null 2>&1 &
        echo "dotoold started in the background."
    else
        echo "dotoold is already running."
    fi
}
--- ./sway_menu.sh ---
#!/bin/bash
# sway_menu.sh

NON_ROOT_USER="blu"
USER_HOME="/home/$NON_ROOT_USER"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Load environment & dotoold
[ -f "$USER_HOME/.secure_env" ] && . "$USER_HOME/.secure_env"
pgrep -x dotoold >/dev/null || (nohup dotoold >/dev/null 2>&1 &)

# Source all libs so the functions exist in this shell
for lib in "$SCRIPT_DIR/lib"/*.sh; do . "$lib"; done

# --- AUTOMATIC MENU GENERATION ---
# Scans for: # menu: Section Name | Display Name
raw_data=$(grep -h "# menu:" "$SCRIPT_DIR/lib"/*.sh | sed 's/# menu: //')

MENU_CONTENT=""
CURRENT_SECTION=""

# Sort by Section (Column 1), then Display Name (Column 2)
while IFS='|' read -r section display_name; do
    section=$(echo "$section" | xargs)
    display_name=$(echo "$display_name" | xargs)
    
    if [[ "$section" != "$CURRENT_SECTION" ]]; then
        MENU_CONTENT+="\n--- $section ---\n"
        CURRENT_SECTION="$section"
    fi
    MENU_CONTENT+="$display_name\n"
done < <(echo "$raw_data" | sort -t'|' -k1,1 -k2,2)

# Show wofi
CHOICE=$(echo -e "$MENU_CONTENT" | sed '/^$/d' | wofi --insensitive --dmenu --cache-file=/dev/null -Dlayer=overlay)

# Exit if cancelled or if a header was clicked
[ -z "$CHOICE" ] || [[ "$CHOICE" == ---* ]] && exit 0

# --- DYNAMIC DISCOVERY ---
# Look for the file and line containing the choice, then find the function name below it
# This regex looks for the function name (e.g., "my_func()") on the line following the comment
FILE_MATCH=$(grep -rlF "$CHOICE" "$SCRIPT_DIR/lib"/)
FUNCTION_NAME=$(grep -A 1 -F "$CHOICE" "$FILE_MATCH" | grep "()" | cut -d'(' -f1 | awk '{print $NF}')

if [ -n "$FUNCTION_NAME" ]; then
    $FUNCTION_NAME
else
    notify-send "Error" "Could not find function for: $CHOICE"
fi